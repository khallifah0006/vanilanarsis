(()=>{"use strict";var n={56:(n,t,e)=>{n.exports=function(n){var t=e.nc;t&&n.setAttribute("nonce",t)}},72:n=>{var t=[];function e(n){for(var e=-1,o=0;o<t.length;o++)if(t[o].identifier===n){e=o;break}return e}function o(n,o){for(var a={},i=[],s=0;s<n.length;s++){var c=n[s],d=o.base?c[0]+o.base:c[0],l=a[d]||0,m="".concat(d," ").concat(l);a[d]=l+1;var p=e(m),u={css:c[1],media:c[2],sourceMap:c[3],supports:c[4],layer:c[5]};if(-1!==p)t[p].references++,t[p].updater(u);else{var h=r(u,o);o.byIndex=s,t.splice(s,0,{identifier:m,updater:h,references:1})}i.push(m)}return i}function r(n,t){var e=t.domAPI(t);return e.update(n),function(t){if(t){if(t.css===n.css&&t.media===n.media&&t.sourceMap===n.sourceMap&&t.supports===n.supports&&t.layer===n.layer)return;e.update(n=t)}else e.remove()}}n.exports=function(n,r){var a=o(n=n||[],r=r||{});return function(n){n=n||[];for(var i=0;i<a.length;i++){var s=e(a[i]);t[s].references--}for(var c=o(n,r),d=0;d<a.length;d++){var l=e(a[d]);0===t[l].references&&(t[l].updater(),t.splice(l,1))}a=c}}},113:n=>{n.exports=function(n,t){if(t.styleSheet)t.styleSheet.cssText=n;else{for(;t.firstChild;)t.removeChild(t.firstChild);t.appendChild(document.createTextNode(n))}}},314:n=>{n.exports=function(n){var t=[];return t.toString=function(){return this.map((function(t){var e="",o=void 0!==t[5];return t[4]&&(e+="@supports (".concat(t[4],") {")),t[2]&&(e+="@media ".concat(t[2]," {")),o&&(e+="@layer".concat(t[5].length>0?" ".concat(t[5]):""," {")),e+=n(t),o&&(e+="}"),t[2]&&(e+="}"),t[4]&&(e+="}"),e})).join("")},t.i=function(n,e,o,r,a){"string"==typeof n&&(n=[[null,n,void 0]]);var i={};if(o)for(var s=0;s<this.length;s++){var c=this[s][0];null!=c&&(i[c]=!0)}for(var d=0;d<n.length;d++){var l=[].concat(n[d]);o&&i[l[0]]||(void 0!==a&&(void 0===l[5]||(l[1]="@layer".concat(l[5].length>0?" ".concat(l[5]):""," {").concat(l[1],"}")),l[5]=a),e&&(l[2]?(l[1]="@media ".concat(l[2]," {").concat(l[1],"}"),l[2]=e):l[2]=e),r&&(l[4]?(l[1]="@supports (".concat(l[4],") {").concat(l[1],"}"),l[4]=r):l[4]="".concat(r)),t.push(l))}},t}},540:n=>{n.exports=function(n){var t=document.createElement("style");return n.setAttributes(t,n.attributes),n.insert(t,n.options),t}},552:(n,t,e)=>{e.d(t,{A:()=>s});var o=e(601),r=e.n(o),a=e(314),i=e.n(a)()(r());i.push([n.id,"\n:root {\n    --primary-color: #5D8BF4;\n    --secondary-color: #9BABF7;\n    --accent-color: #DFF6FF;\n    --dark-color: #051367;\n    --light-color: #F9F9F9;\n    --text-color: #333;\n    --error-color: #FF5252;\n    --success-color: #4CAF50;\n    --shadow: 0 2px 10px rgba(0, 0, 0, 0.1);\n    --transition: all 0.3s ease;\n  }\n  \n  * {\n    margin: 0;\n    padding: 0;\n    box-sizing: border-box;\n    font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;\n  }\n  \n  body {\n    background-color: var(--light-color);\n    color: var(--text-color);\n    line-height: 1.6;\n  }\n  \n  \n  .skip-link {\n    position: absolute;\n    top: -50px;\n    left: 0;\n    background: var(--primary-color);\n    color: white;\n    padding: 10px;\n    z-index: 100;\n    transition: top 0.3s;\n  }\n  \n  .skip-link:focus {\n    top: 0;\n  }\n  \n  \n  header {\n    background-color: white;\n    box-shadow: var(--shadow);\n    position: sticky;\n    top: 0;\n    z-index: 10;\n  }\n  \n  nav {\n    display: flex;\n    justify-content: space-between;\n    align-items: center;\n    padding: 1rem 2rem;\n    max-width: 1200px;\n    margin: 0 auto;\n  }\n  \n  .logo h1 {\n    color: var(--primary-color);\n    font-size: 1.5rem;\n  }\n  \n  .nav-links {\n    display: flex;\n    gap: 1.5rem;\n    align-items: center;\n  }\n  \n  .nav-item {\n    text-decoration: none;\n    color: var(--text-color);\n    font-weight: 500;\n    transition: var(--transition);\n  }\n  \n  .nav-item:hover, .nav-item.active {\n    color: var(--primary-color);\n  }\n  \n  .auth-button {\n    background-color: var(--primary-color);\n    color: white;\n    border: none;\n    padding: 0.5rem 1rem;\n    border-radius: 4px;\n    cursor: pointer;\n    transition: var(--transition);\n  }\n  \n  .auth-button:hover {\n    background-color: var(--dark-color);\n  }\n  \n\n  main {\n    min-height: calc(100vh - 140px);\n    max-width: 1200px;\n    margin: 2rem auto;\n    padding: 0 1rem;\n    view-transition-name: main-content;\n  }\n  \n  \n  .stories-container {\n    display: grid;\n    grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));\n    gap: 2rem;\n    margin-top: 2rem;\n  }\n  \n  .story-card {\n    background-color: white;\n    border-radius: 8px;\n    overflow: hidden;\n    box-shadow: var(--shadow);\n    transition: var(--transition);\n  }\n  \n  .story-card:hover {\n    transform: translateY(-5px);\n    box-shadow: 0 10px 20px rgba(0, 0, 0, 0.1);\n  }\n  \n  .story-image {\n    width: 100%;\n    height: 200px;\n    object-fit: cover;\n  }\n  \n  .story-content {\n    padding: 1.5rem;\n  }\n  \n  .story-author {\n    display: flex;\n    align-items: center;\n    margin-bottom: 0.5rem;\n  }\n  \n  .author-icon {\n    color: var(--primary-color);\n    margin-right: 0.5rem;\n  }\n  \n  .story-title {\n    font-size: 1.25rem;\n    margin-bottom: 0.5rem;\n    color: var(--dark-color);\n  }\n  \n  .story-description {\n    color: var(--text-color);\n    margin-bottom: 1rem;\n    display: -webkit-box;\n    -webkit-line-clamp: 3;\n    -webkit-box-orient: vertical;\n    overflow: hidden;\n  }\n  \n  .story-meta {\n    display: flex;\n    justify-content: space-between;\n    align-items: center;\n    color: #777;\n    font-size: 0.875rem;\n  }\n  \n  .story-detail-button {\n    background-color: var(--secondary-color);\n    color: white;\n    border: none;\n    padding: 0.5rem 1rem;\n    border-radius: 4px;\n    cursor: pointer;\n    transition: var(--transition);\n  }\n  \n  .story-detail-button:hover {\n    background-color: var(--primary-color);\n  }\n  \n  \n  .story-detail-content {\n    width: 80%;\n    max-width: 800px;\n  }\n  \n  .story-detail {\n    display: flex;\n    flex-direction: column;\n    gap: 1rem;\n  }\n  \n  .story-detail-image {\n    width: 100%;\n    max-height: 400px;\n    object-fit: cover;\n    border-radius: 8px;\n  }\n  \n  .story-detail-info {\n    display: flex;\n    justify-content: space-between;\n    flex-wrap: wrap;\n  }\n  \n  .story-map {\n    height: 300px;\n    width: 100%;\n    border-radius: 8px;\n    margin-top: 1rem;\n  }\n  \n  \n  .form-container {\n    background-color: white;\n    padding: 2rem;\n    border-radius: 8px;\n    box-shadow: var(--shadow);\n    max-width: 600px;\n    margin: 0 auto;\n  }\n  \n  .form-title {\n    text-align: center;\n    margin-bottom: 1.5rem;\n    color: var(--dark-color);\n  }\n  \n  .form-group {\n    margin-bottom: 1.5rem;\n  }\n  \n  .form-group label {\n    display: block;\n    margin-bottom: 0.5rem;\n    font-weight: 500;\n  }\n  \n  .form-group input,\n  .form-group textarea {\n    width: 100%;\n    padding: 0.75rem;\n    border: 1px solid #ddd;\n    border-radius: 4px;\n    transition: var(--transition);\n  }\n  \n  .form-group input:focus,\n  .form-group textarea:focus {\n    border-color: var(--primary-color);\n    outline: none;\n  }\n  \n  .camera-container {\n    display: flex;\n    flex-direction: column;\n    gap: 1rem;\n    margin-bottom: 1.5rem;\n  }\n  \n  .camera-preview {\n    width: 100%;\n    height: 300px;\n    background-color: #f0f0f0;\n    border-radius: 4px;\n    overflow: hidden;\n    display: flex;\n    justify-content: center;\n    align-items: center;\n  }\n  \n  .camera-preview video,\n  .camera-preview img {\n    max-width: 100%;\n    max-height: 100%;\n  }\n  \n  .camera-buttons {\n    display: flex;\n    gap: 1rem;\n  }\n  \n  .add-map {\n    height: 300px;\n    margin-bottom: 1.5rem;\n    border-radius: 4px;\n    overflow: hidden;\n  }\n  \n  .btn {\n    padding: 0.75rem 1.5rem;\n    border: none;\n    border-radius: 4px;\n    font-weight: 500;\n    cursor: pointer;\n    transition: var(--transition);\n  }\n  \n  .btn-primary {\n    background-color: var(--primary-color);\n    color: white;\n  }\n  \n  .btn-secondary {\n    background-color: var(--secondary-color);\n    color: white;\n  }\n  \n  .btn-danger {\n    background-color: var(--error-color);\n    color: white;\n  }\n  \n  .btn:hover {\n    filter: brightness(90%);\n  }\n  \n  \n  .modal {\n    display: none;\n    position: fixed;\n    z-index: 100;\n    left: 0;\n    top: 0;\n    width: 100%;\n    height: 100%;\n    background-color: rgba(0, 0, 0, 0.5);\n    overflow: auto;\n  }\n  \n  .modal-content {\n    background-color: white;\n    margin: 10% auto;\n    padding: 2rem;\n    border-radius: 8px;\n    width: 80%;\n    max-width: 500px;\n    box-shadow: var(--shadow);\n    animation: modalIn 0.3s;\n  }\n  \n  @keyframes modalIn {\n    from {\n      opacity: 0;\n      transform: translateY(-50px);\n    }\n    to {\n      opacity: 1;\n      transform: translateY(0);\n    }\n  }\n  \n  .close {\n    color: #aaa;\n    float: right;\n    font-size: 28px;\n    font-weight: bold;\n    cursor: pointer;\n    transition: var(--transition);\n  }\n  \n  .close:hover {\n    color: var(--dark-color);\n  }\n  \n  \n  .notification {\n    position: fixed;\n    bottom: 2rem;\n    right: 2rem;\n    background-color: var(--success-color);\n    color: white;\n    padding: 1rem 2rem;\n    border-radius: 4px;\n    box-shadow: var(--shadow);\n    z-index: 100;\n    animation: fadeIn 0.3s;\n  }\n  \n  .notification.error {\n    background-color: var(--error-color);\n  }\n  \n  @keyframes fadeIn {\n    from {\n      opacity: 0;\n      transform: translateY(20px);\n    }\n    to {\n      opacity: 1;\n      transform: translateY(0);\n    }\n  }\n  \n  .hidden {\n    display: none;\n  }\n  \n \n  footer {\n    text-align: center;\n    padding: 1.5rem;\n    background-color: white;\n    border-top: 1px solid #eee;\n  }\n  \n  \n  .loader {\n    display: flex;\n    justify-content: center;\n    padding: 2rem;\n  }\n  \n  .spinner {\n    width: 40px;\n    height: 40px;\n    border: 4px solid rgba(0, 0, 0, 0.1);\n    border-radius: 50%;\n    border-left-color: var(--primary-color);\n    animation: spin 1s linear infinite;\n  }\n  \n  @keyframes spin {\n    0% {\n      transform: rotate(0deg);\n    }\n    100% {\n      transform: rotate(360deg);\n    }\n  }\n  \n \n  ::view-transition-old(main-content),\n  ::view-transition-new(main-content) {\n    animation: none;\n    mix-blend-mode: normal;\n  }\n  \n  ::view-transition-old(main-content) {\n    opacity: 0;\n  }\n  \n  ::view-transition-new(main-content) {\n    animation: fadeIn 0.5s ease;\n  }\n  \n \n  .profile-container {\n    background-color: white;\n    padding: 2rem;\n    border-radius: 8px;\n    box-shadow: var(--shadow);\n  }\n  \n  .profile-header {\n    text-align: center;\n    margin-bottom: 2rem;\n  }\n  \n  .profile-avatar {\n    width: 100px;\n    height: 100px;\n    border-radius: 50%;\n    object-fit: cover;\n    margin-bottom: 1rem;\n    background-color: var(--secondary-color);\n    color: white;\n    display: flex;\n    justify-content: center;\n    align-items: center;\n    font-size: 2.5rem;\n    margin: 0 auto;\n  }\n  \n  .profile-name {\n    margin-top: 1rem;\n    color: var(--dark-color);\n  }\n  \n  .profile-email {\n    color: #777;\n  }\n  \n  .notifications-section {\n    margin-top: 2rem;\n    border-top: 1px solid #eee;\n    padding-top: 2rem;\n  }\n  \n  .toggle-container {\n    display: flex;\n    align-items: center;\n    gap: 1rem;\n    margin-top: 1rem;\n  }\n  \n  .toggle-switch {\n    position: relative;\n    display: inline-block;\n    width: 60px;\n    height: 34px;\n  }\n  \n  .toggle-switch input {\n    opacity: 0;\n    width: 0;\n    height: 0;\n  }\n  \n  .slider {\n    position: absolute;\n    cursor: pointer;\n    top: 0;\n    left: 0;\n    right: 0;\n    bottom: 0;\n    background-color: #ccc;\n    transition: var(--transition);\n    border-radius: 34px;\n  }\n  \n  .slider:before {\n    position: absolute;\n    content: \"\";\n    height: 26px;\n    width: 26px;\n    left: 4px;\n    bottom: 4px;\n    background-color: white;\n    transition: var(--transition);\n    border-radius: 50%;\n  }\n  \n  input:checked + .slider {\n    background-color: var(--primary-color);\n  }\n  \n  input:checked + .slider:before {\n    transform: translateX(26px);\n  }\n  \n\n  @media (max-width: 768px) {\n    nav {\n      flex-direction: column;\n      padding: 1rem;\n    }\n    \n    .nav-links {\n      margin-top: 1rem;\n      flex-wrap: wrap;\n      justify-content: center;\n    }\n    \n    .stories-container {\n      grid-template-columns: 1fr;\n    }\n    \n    .modal-content {\n      width: 95%;\n      margin: 5% auto;\n    }\n    \n    .story-detail-content {\n      width: 95%;\n    }\n  }",""]);const s=i},601:n=>{n.exports=function(n){return n[1]}},659:n=>{var t={};n.exports=function(n,e){var o=function(n){if(void 0===t[n]){var e=document.querySelector(n);if(window.HTMLIFrameElement&&e instanceof window.HTMLIFrameElement)try{e=e.contentDocument.head}catch(n){e=null}t[n]=e}return t[n]}(n);if(!o)throw new Error("Couldn't find a style target. This probably means that the value for the 'insert' parameter is invalid.");o.appendChild(e)}},825:n=>{n.exports=function(n){if("undefined"==typeof document)return{update:function(){},remove:function(){}};var t=n.insertStyleElement(n);return{update:function(e){!function(n,t,e){var o="";e.supports&&(o+="@supports (".concat(e.supports,") {")),e.media&&(o+="@media ".concat(e.media," {"));var r=void 0!==e.layer;r&&(o+="@layer".concat(e.layer.length>0?" ".concat(e.layer):""," {")),o+=e.css,r&&(o+="}"),e.media&&(o+="}"),e.supports&&(o+="}");var a=e.sourceMap;a&&"undefined"!=typeof btoa&&(o+="\n/*# sourceMappingURL=data:application/json;base64,".concat(btoa(unescape(encodeURIComponent(JSON.stringify(a))))," */")),t.styleTagTransform(o,n,t.options)}(t,n,e)},remove:function(){!function(n){if(null===n.parentNode)return!1;n.parentNode.removeChild(n)}(t)}}}}},t={};function e(o){var r=t[o];if(void 0!==r)return r.exports;var a=t[o]={id:o,exports:{}};return n[o](a,a.exports,e),a.exports}e.n=n=>{var t=n&&n.__esModule?()=>n.default:()=>n;return e.d(t,{a:t}),t},e.d=(n,t)=>{for(var o in t)e.o(t,o)&&!e.o(n,o)&&Object.defineProperty(n,o,{enumerable:!0,get:t[o]})},e.o=(n,t)=>Object.prototype.hasOwnProperty.call(n,t),e.nc=void 0;var o=e(72),r=e.n(o),a=e(825),i=e.n(a),s=e(659),c=e.n(s),d=e(56),l=e.n(d),m=e(540),p=e.n(m),u=e(113),h=e.n(u),g=e(552),y={};y.styleTagTransform=h(),y.setAttributes=l(),y.insert=c().bind(null,"head"),y.domAPI=i(),y.insertStyleElement=p(),r()(g.A,y),g.A&&g.A.locals&&g.A.locals;const f="https://story-api.dicoding.dev/v1",v=[-6.2088,106.8456];let b,w,x,k=localStorage.getItem("token"),E=localStorage.getItem("userId"),S=localStorage.getItem("name"),I=null;const T={async login(n,t){try{const e=await fetch(`${f}/login`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({email:n,password:t})}),o=await e.json();if(o.error)throw new Error(o.message);return localStorage.setItem("token",o.loginResult.token),localStorage.setItem("userId",o.loginResult.userId),localStorage.setItem("name",o.loginResult.name),k=o.loginResult.token,E=o.loginResult.userId,S=o.loginResult.name,o}catch(n){throw n}},async register(n,t,e){try{const o=await fetch(`${f}/register`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({name:n,email:t,password:e})}),r=await o.json();if(r.error)throw new Error(r.message);return r}catch(n){throw n}},logout(){localStorage.removeItem("token"),localStorage.removeItem("userId"),localStorage.removeItem("name"),k=null,E=null,S=null},async getAllStories(n=1,t=10,e=0){try{let o=`${f}/stories?page=${n}&size=${t}&location=${e}`;const r={};k&&(r.Authorization=`Bearer ${k}`);const a=await fetch(o,{headers:r}),i=await a.json();if(i.error)throw new Error(i.message);return i.listStory}catch(n){throw n}},async getStoryDetail(n){try{const t=await fetch(`${f}/stories/${n}`,{headers:{Authorization:`Bearer ${k}`}}),e=await t.json();if(e.error)throw new Error(e.message);return e.story}catch(n){throw n}},async addStory(n,t,e,o){try{const r=new FormData;r.append("description",n),r.append("photo",t),e&&o&&(r.append("lat",e),r.append("lon",o));let a=`${f}/stories`;const i={};k?i.Authorization=`Bearer ${k}`:a=`${f}/stories/guest`;const s=await fetch(a,{method:"POST",headers:i,body:r}),c=await s.json();if(c.error)throw new Error(c.message);return c}catch(n){throw n}},async subscribeNotification(n){try{const t=await fetch(`${f}/notifications/subscribe`,{method:"POST",headers:{"Content-Type":"application/json",Authorization:`Bearer ${k}`},body:JSON.stringify({endpoint:n.endpoint,keys:{p256dh:btoa(String.fromCharCode.apply(null,new Uint8Array(n.getKey("p256dh")))),auth:btoa(String.fromCharCode.apply(null,new Uint8Array(n.getKey("auth"))))}})}),e=await t.json();if(e.error)throw new Error(e.message);return e}catch(n){throw n}},async unsubscribeNotification(n){try{const t=await fetch(`${f}/notifications/subscribe`,{method:"DELETE",headers:{"Content-Type":"application/json",Authorization:`Bearer ${k}`},body:JSON.stringify({endpoint:n.endpoint})}),e=await t.json();if(e.error)throw new Error(e.message);return e}catch(n){throw n}}},B={init(){this.initRouter(),this.initEventListeners(),this.updateAuthUI()},initRouter(){window.addEventListener("hashchange",this.handleRouteChange.bind(this)),this.handleRouteChange()},handleRouteChange(){const n=window.location.hash||"#/",t={"#/":this.renderHome.bind(this),"#/add-story":this.renderAddStory.bind(this),"#/profile":this.renderProfile.bind(this)};document.startViewTransition?document.startViewTransition((()=>{(t[n]||t["#/"])(),document.querySelectorAll(".nav-item").forEach((t=>{t.getAttribute("href")===n?t.classList.add("active"):t.classList.remove("active")}))})):((t[n]||t["#/"])(),document.querySelectorAll(".nav-item").forEach((t=>{t.getAttribute("href")===n?t.classList.add("active"):t.classList.remove("active")})))},initEventListeners(){document.getElementById("login-button").addEventListener("click",(()=>{document.getElementById("login-modal").style.display="block"})),document.getElementById("register-button").addEventListener("click",(()=>{document.getElementById("register-modal").style.display="block"})),document.getElementById("logout-button").addEventListener("click",(()=>{T.logout(),this.updateAuthUI(),this.showNotification("Logged out successfully"),window.location.hash="#/"})),document.getElementById("login-form").addEventListener("submit",(async n=>{n.preventDefault();const t=document.getElementById("login-email").value,e=document.getElementById("login-password").value;try{await T.login(t,e),document.getElementById("login-modal").style.display="none",this.updateAuthUI(),this.showNotification("Logged in successfully"),window.location.hash="#/"}catch(n){this.showNotification(n.message,!0)}})),document.getElementById("register-form").addEventListener("submit",(async n=>{n.preventDefault();const t=document.getElementById("register-name").value,e=document.getElementById("register-email").value,o=document.getElementById("register-password").value;try{await T.register(t,e,o),document.getElementById("register-modal").style.display="none",this.showNotification("Registration successful. Please login.")}catch(n){this.showNotification(n.message,!0)}})),document.querySelectorAll(".close").forEach((n=>{n.addEventListener("click",(()=>{document.querySelectorAll(".modal").forEach((n=>{n.style.display="none"})),x&&(x.getTracks().forEach((n=>n.stop())),x=null)}))})),window.addEventListener("click",(n=>{document.querySelectorAll(".modal").forEach((t=>{n.target===t&&(t.style.display="none",x&&(x.getTracks().forEach((n=>n.stop())),x=null))}))}))},updateAuthUI(){const n=document.getElementById("login-button"),t=document.getElementById("register-button"),e=document.getElementById("logout-button"),o=document.getElementById("profile-link");k?(n.classList.add("hidden"),t.classList.add("hidden"),e.classList.remove("hidden"),o.classList.remove("hidden")):(n.classList.remove("hidden"),t.classList.remove("hidden"),e.classList.add("hidden"),o.classList.add("hidden"))},async renderHome(){document.getElementById("app").innerHTML='\n      <h2>Recent Stories</h2>\n      <div class="loader">\n        <div class="spinner"></div>\n      </div>\n      <div class="stories-container"></div>\n    ';try{const n=await T.getAllStories(1,20,1),t=document.querySelector(".stories-container");0===n.length?t.innerHTML="<p>No stories found. Be the first to share a story!</p>":(t.innerHTML=n.map((n=>`\n          <article class="story-card">\n            <img src="${n.photoUrl}" alt="Photo for story by ${n.name}" class="story-image">\n            <div class="story-content">\n              <div class="story-author">\n                <i class="fas fa-user author-icon"></i>\n                <span>${n.name}</span>\n              </div>\n              <h3 class="story-title">Story by ${n.name}</h3>\n              <p class="story-description">${n.description}</p>\n              <div class="story-meta">\n                <span><i class="fas fa-calendar"></i> ${new Date(n.createdAt).toLocaleDateString()}</span>\n                <button class="story-detail-button" data-id="${n.id}">View Details</button>\n              </div>\n            </div>\n          </article>\n        `)).join(""),document.querySelectorAll(".story-detail-button").forEach((n=>{n.addEventListener("click",(async()=>{const t=n.getAttribute("data-id");this.showStoryDetail(t)}))}))),document.querySelector(".loader").remove()}catch(n){document.querySelector(".loader").remove(),this.showNotification(n.message,!0)}},async showStoryDetail(n){const t=document.getElementById("story-detail-modal"),e=document.getElementById("story-detail-container");e.innerHTML='\n        <div class="loader">\n          <div class="spinner"></div>\n        </div>\n      ',t.style.display="block";try{const t=await T.getStoryDetail(n);e.innerHTML=`\n          <div class="story-detail">\n            <img src="${t.photoUrl}" alt="Photo for story by ${t.name}" class="story-detail-image">\n            <div class="story-detail-info">\n              <div>\n                <h3>${t.name}'s Story</h3>\n                <p><i class="fas fa-calendar"></i> ${new Date(t.createdAt).toLocaleDateString()}</p>\n              </div>\n            </div>\n            <p>${t.description}</p>\n            ${t.lat&&t.lon?'<div id="detail-map" class="story-map"></div>':""}\n          </div>\n        `,t.lat&&t.lon&&setTimeout((()=>{const n=L.map("detail-map").setView([t.lat,t.lon],13),e=L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png",{attribution:'&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors'}),o={Street:e,Satellite:L.tileLayer("https://{s}.google.com/vt/lyrs=s&x={x}&y={y}&z={z}",{maxZoom:20,subdomains:["mt0","mt1","mt2","mt3"],attribution:"&copy; Google Maps"}),Topographic:L.tileLayer("https://{s}.tile.opentopomap.org/{z}/{x}/{y}.png",{attribution:'&copy; <a href="https://opentopomap.org">OpenTopoMap</a> contributors'})};e.addTo(n),L.control.layers(o).addTo(n),L.marker([t.lat,t.lon]).addTo(n).bindPopup(`<strong>${t.name}'s Story</strong><br>${t.description.substring(0,100)}...`).openPopup()}),100)}catch(n){e.innerHTML=`<p class="error">Error loading story details: ${n.message}</p>`}},async renderAddStory(){document.getElementById("app").innerHTML='\n        <div class="form-container">\n          <h2 class="form-title">Share Your Story</h2>\n          <form id="add-story-form">\n            <div class="camera-container">\n              <label>Take a Photo</label>\n              <div class="camera-preview" id="camera-preview">\n                <i class="fas fa-camera fa-3x"></i>\n              </div>\n              <div class="camera-buttons">\n                <button type="button" id="start-camera" class="btn btn-secondary">\n                  <i class="fas fa-camera"></i> Start Camera\n                </button>\n                <button type="button" id="capture-photo" class="btn btn-primary" disabled>\n                  <i class="fas fa-camera-retro"></i> Capture\n                </button>\n                <button type="button" id="retry-photo" class="btn btn-danger" disabled>\n                  <i class="fas fa-redo"></i> Retry\n                </button>\n              </div>\n            </div>\n            \n            <div class="form-group">\n              <label for="story-description">Description</label>\n              <textarea id="story-description" rows="4" required></textarea>\n            </div>\n            \n            <div>\n              <label>Select Location (Click on the map)</label>\n              <div id="add-map" class="add-map"></div>\n              <div class="form-group">\n                <label for="story-location">Selected Location</label>\n                <input type="text" id="story-location" readonly>\n              </div>\n            </div>\n            \n            <button type="submit" class="btn btn-primary">\n              <i class="fas fa-paper-plane"></i> Share Story\n            </button>\n          </form>\n        </div>\n      ',setTimeout((()=>{b=L.map("add-map").setView(v,13);const n=L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png",{attribution:'&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors'}),t={Street:n,Satellite:L.tileLayer("https://{s}.google.com/vt/lyrs=s&x={x}&y={y}&z={z}",{maxZoom:20,subdomains:["mt0","mt1","mt2","mt3"],attribution:"&copy; Google Maps"}),Topographic:L.tileLayer("https://{s}.tile.opentopomap.org/{z}/{x}/{y}.png",{attribution:'&copy; <a href="https://opentopomap.org">OpenTopoMap</a> contributors'})};n.addTo(b),L.control.layers(t).addTo(b),b.on("click",(n=>{w&&b.removeLayer(w),w=L.marker(n.latlng).addTo(b),document.getElementById("story-location").value=`Lat: ${n.latlng.lat.toFixed(6)}, Lng: ${n.latlng.lng.toFixed(6)}`}))}),100);let n=null;const t=document.getElementById("start-camera"),e=document.getElementById("capture-photo"),o=document.getElementById("retry-photo"),r=document.getElementById("camera-preview");t.addEventListener("click",(async()=>{try{x=await navigator.mediaDevices.getUserMedia({video:{facingMode:"environment"},audio:!1});const n=document.createElement("video");n.srcObject=x,n.autoplay=!0,n.id="camera-stream",r.innerHTML="",r.appendChild(n),t.disabled=!0,e.disabled=!1}catch(n){this.showNotification("Failed to access camera: "+n.message,!0)}})),e.addEventListener("click",(()=>{const t=document.getElementById("camera-stream"),a=document.createElement("canvas");a.width=t.videoWidth,a.height=t.videoHeight,a.getContext("2d").drawImage(t,0,0,a.width,a.height);const i=document.createElement("img");i.src=a.toDataURL("image/jpeg"),i.id="captured-image",a.toBlob((t=>{n=t}),"image/jpeg"),r.innerHTML="",r.appendChild(i),e.disabled=!0,o.disabled=!1,x&&x.getTracks().forEach((n=>n.stop()))})),o.addEventListener("click",(()=>{n=null,r.innerHTML='<i class="fas fa-camera fa-3x"></i>',t.disabled=!1,e.disabled=!0,o.disabled=!0})),document.getElementById("add-story-form").addEventListener("submit",(async a=>{if(a.preventDefault(),!n)return void this.showNotification("Please take a photo first",!0);const i=document.getElementById("story-description").value;let s=null,c=null;w&&(s=w.getLatLng().lat,c=w.getLatLng().lng);try{await T.addStory(i,n,s,c),this.showNotification("Story shared successfully!"),document.getElementById("add-story-form").reset(),r.innerHTML='<i class="fas fa-camera fa-3x"></i>',n=null,w&&(b.removeLayer(w),w=null),t.disabled=!1,e.disabled=!0,o.disabled=!0,setTimeout((()=>{window.location.hash="#/"}),1500)}catch(n){this.showNotification(n.message,!0)}}))},renderProfile(){if(!k)return this.showNotification("Please login to view your profile",!0),void(window.location.hash="#/");const n=document.getElementById("app"),t=S?S.charAt(0).toUpperCase():"U";n.innerHTML=`\n        <div class="profile-container">\n          <div class="profile-header">\n            <div class="profile-avatar">${t}</div>\n            <h2 class="profile-name">${S||"User"}</h2>\n            <p class="profile-email">User ID: ${E||"Unknown"}</p>\n          </div>\n          \n          <div class="notifications-section">\n            <h3>Push Notifications</h3>\n            <p>Get notified when your stories are published.</p>\n            \n            <div class="toggle-container">\n              <label class="toggle-switch">\n                <input type="checkbox" id="notifications-toggle">\n                <span class="slider"></span>\n              </label>\n              <span>Enable Push Notifications</span>\n            </div>\n          </div>\n        </div>\n      `;const e=document.getElementById("notifications-toggle");"serviceWorker"in navigator&&"PushManager"in window?navigator.serviceWorker.register("./service-worker.js").then((async n=>{const t=await n.pushManager.getSubscription();t&&(I=t,e.checked=!0),e.addEventListener("change",(async()=>{if(e.checked)try{const t=await n.pushManager.subscribe({userVisibleOnly:!0,applicationServerKey:this.urlBase64ToUint8Array("BCCs2eonMI-6H2ctvFaWg-UYdDv387Vno_bzUzALpB442r2lCnsHmtrx8biyPi_E-1fSGABK_Qs_GlvPoJJqxbk")});I=t,await T.subscribeNotification(t),this.showNotification("Push notifications enabled")}catch(n){e.checked=!1,this.showNotification("Failed to enable push notifications: "+n.message,!0)}else try{I&&(await T.unsubscribeNotification(I),await I.unsubscribe(),I=null,this.showNotification("Push notifications disabled"))}catch(n){this.showNotification("Failed to disable push notifications: "+n.message,!0)}}))})).catch((n=>{console.error("Service Worker registration failed:",n),e.disabled=!0,e.parentElement.nextElementSibling.textContent="Push notifications not available"})):(e.disabled=!0,e.parentElement.nextElementSibling.textContent="Push notifications not supported on this browser")},showNotification(n,t=!1){const e=document.getElementById("notification"),o=document.getElementById("notification-message");e.classList.remove("hidden","error"),t&&e.classList.add("error"),o.textContent=n,setTimeout((()=>{e.classList.add("hidden")}),3e3)},urlBase64ToUint8Array(n){const t=(n+"=".repeat((4-n.length%4)%4)).replace(/-/g,"+").replace(/_/g,"/"),e=window.atob(t),o=new Uint8Array(e.length);for(let n=0;n<e.length;++n)o[n]=e.charCodeAt(n);return o}};"serviceWorker"in navigator&&window.addEventListener("load",(()=>{navigator.serviceWorker.register("./service-worker.js").catch((n=>{console.error("Service Worker registration failed:",n)}))})),document.addEventListener("DOMContentLoaded",(()=>{B.init()}))})();